-- BASE DE DATOS UTILIZADA

USE GD2C2013


-- CREACION DEL ESQUEMA

BEGIN TRANSACTION
IF NOT EXISTS ( SELECT *
				FROM sys.schemas 
				WHERE name = N'VARIETE_GDD')  
EXEC sys.sp_executesql N'CREATE SCHEMA [VARIETE_GDD] AUTHORIZATION [gd]'
COMMIT;



-- DROP FK
IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.AFI_DNI') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.AFILIADO DROP CONSTRAINT AFI_DNI;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.AFI_PLAN_MEDICO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.AFILIADO DROP CONSTRAINT AFI_PLAN_MEDICO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PRO_DNI') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.PROFESIONAL DROP CONSTRAINT PRO_DNI;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PROESP_PROFESIONAL') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.PROFESIONAL_ESPECIALIDADES DROP CONSTRAINT PROESP_PROFESIONAL;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PROESP_ESPECIALIDAD') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.PROFESIONAL_ESPECIALIDADES DROP CONSTRAINT PROESP_ESPECIALIDAD;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.ROLUSU_USUARIO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.ROL_USUARIO DROP CONSTRAINT ROLUSU_USUARIO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.ROLUSU_ROL') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.ROL_USUARIO DROP CONSTRAINT ROLUSU_ROL;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.ROLFUN_ROL') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.ROL_FUNCIONALIDADES DROP CONSTRAINT ROLFUN_ROL;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.ROLFUN_FUNCIONALIDAD') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.ROL_FUNCIONALIDADES DROP CONSTRAINT ROLFUN_FUNCIONALIDAD;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.TUR_PROFESIONAL') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.TURNOS DROP CONSTRAINT TUR_PROFESIONAL;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.TUR_AFILIADO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.TURNOS DROP CONSTRAINT TUR_AFILIADO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.BONCON_AFILIADO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.BONO_CONSULTA DROP CONSTRAINT BONCON_AFILIADO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.BONCON_CONSULTA') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.BONO_CONSULTA DROP CONSTRAINT BONCON_CONSULTA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.BONCON_PLAN') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.BONO_CONSULTA DROP CONSTRAINT BONCON_PLAN;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.BONCON_COMPRA') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.BONO_CONSULTA DROP CONSTRAINT BONCON_COMPRA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.CON_PROFESIONAL') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.CONSULTA DROP CONSTRAINT CON_PROFESIONAL;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.CON_AFILIADO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.CONSULTA DROP CONSTRAINT CON_AFILIADO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.CON_TURNOS') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.CONSULTA DROP CONSTRAINT CON_TURNOS;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.CON_BONO_CONSULTA') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.CONSULTA DROP CONSTRAINT CON_BONO_CONSULTA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.BONFAR_AFILIADO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.BONO_FARMACIA DROP CONSTRAINT BONFAR_AFILIADO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.BONFAR_PLAN') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.BONO_FARMACIA DROP CONSTRAINT BONFAR_PLAN;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.REC_BONFAR') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.RECETA DROP CONSTRAINT REC_BONFAR;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.RECMED_RECETA') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.RECETA_MEDICAMENTOS DROP CONSTRAINT RECMED_RECETA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.RECMED_MEDICAMENTOS') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.RECETA_MEDICAMENTOS DROP CONSTRAINT RECMED_MEDICAMENTOS;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.COM_AFILIADO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.COMPRA DROP CONSTRAINT COM_AFILIADO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.AGE_PROFESIONAL') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.AGENDA DROP CONSTRAINT AGE_PROFESIONAL;

--IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.DIAATE_AGENDA') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
--ALTER TABLE VARIETE_GDD.DIAS_ATENCION DROP CONSTRAINT DIAATE_AGENDA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PLAMOD_PLAN_NUEVO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.PLANES_MODIFICADOS DROP CONSTRAINT PLAMOD_PLAN_NUEVO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PLAMOD_PLAN_VIEJO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.PLANES_MODIFICADOS DROP CONSTRAINT PLAMOD_PLAN_VIEJO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PLAMOD_AFILIADO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.PLANES_MODIFICADOS DROP CONSTRAINT PLAMOD_AFILIADO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.CANTUR_TURNO') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.CANCELACION_TURNO DROP CONSTRAINT CANTUR_TURNO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.BONFAR_COMPRA') AND OBJECTPROPERTY(id, 'IsForeignKey') = 1)
ALTER TABLE VARIETE_GDD.BONO_FARMACIA DROP CONSTRAINT BONFAR_COMPRA;

-- DROP TABLAS

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PROFESIONAL') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.PROFESIONAL;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PROFESIONAL_ESPECIALIDADES') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.PROFESIONAL_ESPECIALIDADES;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.ESPECIALIDADES') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.ESPECIALIDADES;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.ROL_USUARIO') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.ROL_USUARIO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.ROL') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.ROL;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.ROL_FUNCIONALIDADES') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.ROL_FUNCIONALIDADES;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.FUNCIONALIDADES') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.FUNCIONALIDADES;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.TURNOS') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.TURNOS;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.BONO_CONSULTA') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.BONO_CONSULTA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.CONSULTA') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.CONSULTA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.BONO_FARMACIA') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.BONO_FARMACIA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.RECETA') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.RECETA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.RECETA_MEDICAMENTOS') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.RECETA_MEDICAMENTOS;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.MEDICAMENTOS') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.MEDICAMENTOS;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.COMPRA') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.COMPRA;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.AGENDA') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.AGENDA;

--IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.DIAS_ATENCION') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
--DROP TABLE VARIETE_GDD.DIAS_ATENCION;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.AFILIADO') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.AFILIADO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.USUARIO') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.USUARIO;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PLANES_MODIFICADOS') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.PLANES_MODIFICADOS;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.PLANES') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.PLANES;

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE id = object_id('VARIETE_GDD.CANCELACION_TURNO') AND  OBJECTPROPERTY(id, 'IsUserTable') = 1)
DROP TABLE VARIETE_GDD.CANCELACION_TURNO;


-- DROP PROCEDURES

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_AFILIADOS') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_AFILIADOS;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_PROFESIONALES') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_PROFESIONALES;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_PLANES') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_PLANES;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_ESPECIALIDADES') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_ESPECIALIDADES;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_TURNOS') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_TURNOS;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_COMPRAS_BONOS') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_COMPRAS_BONOS;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_BONOS_CONSULTA') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_BONOS_CONSULTA;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_CONSULTA') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_CONSULTA;


IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.INSERT_ROL') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.INSERT_ROL;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_BONOS_FARMACIA') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_BONOS_FARMACIA;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_RECETA') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_RECETA;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_MEDICAMENTOS') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_MEDICAMENTOS;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.ADMINISTRADOR') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.ADMINISTRADOR;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.ROL') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.ROL;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_FUNCIONALIDADES') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_FUNCIONALIDADES;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.INSERT_ROL_FUNCIONALIDADES') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.INSERT_ROL_FUNCIONALIDADES;

IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.MIGRA_AGENDA') AND type in (N'P', N'PC'))
DROP PROCEDURE VARIETE_GDD.MIGRA_AGENDA;


--IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID('VARIETE_GDD.DIAS_ATENCION') AND type in (N'P', N'PC'))
--DROP PROCEDURE VARIETE_GDD.DIAS_ATENCION;
--GO



-- CREACION DE TABLAS
CREATE TABLE VARIETE_GDD.USUARIO (
	USU_DNI NUMERIC(8) NOT NULL,
	USU_USERNAME VARCHAR(255) UNIQUE NOT NULL ,
	USU_CLAVE VARCHAR(255) NOT NULL,
	USU_CANTIDAD_INTENTOS INTEGER DEFAULT '0',
	USU_HABILITADO BIT DEFAULT '1',
	USU_TIPO_DOCUMENTO VARCHAR(3) DEFAULT 'DNI',
	USU_NOMBRES VARCHAR(255),
	USU_APELLIDO VARCHAR(255),
	USU_DIRECCION VARCHAR(255),
	USU_TELEFONO NUMERIC(18),
	USU_MAIL VARCHAR(255),
	USU_FECHA_NACIMIENTO DATETIME,
	USU_SEXO CHAR DEFAULT 'N' --'F' O 'M'
)


CREATE TABLE VARIETE_GDD.AFILIADO ( 
	AFI_NUMERO INTEGER IDENTITY (1,1) NOT NULL,
	AFI_GRUPO INTEGER DEFAULT '01',
	AFI_DNI NUMERIC(8) NOT NULL,
	AFI_ESTADO_CIVIL VARCHAR(11) DEFAULT 'N',
	AFI_CANTIDAD_FAMILIARES INTEGER DEFAULT '0',
	AFI_PLAN_MEDICO NUMERIC(18) NOT NULL,
	AFI_CANTIDAD_CONSULTAS INTEGER DEFAULT '0'	
)


CREATE TABLE VARIETE_GDD.PROFESIONAL ( 
	PRO_DNI NUMERIC(8) NOT NULL,
	PRO_MATRICULA VARCHAR(50) DEFAULT '000'
)


CREATE TABLE VARIETE_GDD.PROFESIONAL_ESPECIALIDADES (
	PROESP_PROFESIONAL NUMERIC(8) NOT NULL,
	PROESP_ESPECIALIDAD INTEGER NOT NULL
)


CREATE TABLE VARIETE_GDD.ESPECIALIDADES (
	ESP_CODIGO INTEGER UNIQUE NOT NULL,
	ESP_DESCRIPCION VARCHAR (255),
	ESP_TIPO VARCHAR(80),
	ESP_TIPO_DESCRIPCION VARCHAR (255)
)


CREATE TABLE VARIETE_GDD.ROL_USUARIO (
	ROLUSU_USUARIO NUMERIC(8) NOT NULL,
	ROLUSU_ROL VARCHAR (15) NOT NULL
)


CREATE TABLE VARIETE_GDD.ROL (
	ROL_NOMBRE VARCHAR (15) UNIQUE NOT NULL, --AFILIADO O PROFESIONAL O ADMINISTRADOR
	ROL_HABILITADO BIT NOT NULL
)


CREATE TABLE VARIETE_GDD.ROL_FUNCIONALIDADES (
	ROLFUN_ROL VARCHAR (15) NOT NULL, --Saque el UNIQUE ya que al momento de cargarlo no es unico
	ROLFUN_FUNCIONALIDAD INTEGER NOT NULL
)	


CREATE TABLE VARIETE_GDD.FUNCIONALIDADES (
	FUN_CODIGO INTEGER NOT NULL,
	FUN_DESCRIPCION VARCHAR(80) NOT NULL
)


CREATE TABLE VARIETE_GDD.TURNOS (
	TUR_CODIGO INTEGER IDENTITY NOT NULL,
	TUR_PROFESIONAL NUMERIC(8) NOT NULL,
	TUR_AFILIADO NUMERIC(8) NOT NULL,
	TUR_FECHA DATETIME NOT NULL
)	


CREATE TABLE VARIETE_GDD.BONO_CONSULTA (
	BONCON_CODIGO INTEGER IDENTITY NOT NULL,
	BONCON_AFILIADO NUMERIC(8) NOT NULL,
	BONCON_CONSULTA INTEGER NOT NULL,
	BONCON_FECHA DATETIME NOT NULL,
	BONCON_PLAN NUMERIC(18) NOT NULL,
	BONCON_COMPRA INTEGER NOT NULL
)

CREATE TABLE VARIETE_GDD.CONSULTA (
	CON_CODIGO INTEGER IDENTITY(1,1) NOT NULL,
	CON_PROFESIONAL NUMERIC(8) NOT NULL, 
	CON_AFILIADO NUMERIC(8) NOT NULL,
	CON_TURNOS INTEGER NOT NULL,
	CON_FECHA_LLEGADA DATETIME,
	CON_SINTOMAS VARCHAR(255),
	CON_DIAGNOSTICO VARCHAR(1000),
	CON_BONO_CONSULTA INTEGER NOT NULL,
	CON_REALIZADA BIT DEFAULT '1'
)


CREATE TABLE VARIETE_GDD.BONO_FARMACIA (
	BONFAR_CODIGO INTEGER IDENTITY NOT NULL,
	BONFAR_AFILIADO NUMERIC(8) NOT NULL,
	BONFAR_FECHA DATETIME NOT NULL,
	BONFAR_PLAN NUMERIC(18) NOT NULL,
	BONFAR_COMPRA INTEGER NOT NULL 
)


CREATE TABLE VARIETE_GDD.RECETA (
	REC_CODIGO INTEGER IDENTITY(1,1) NOT NULL,
	REC_BONFAR INTEGER NOT NULL  
)


CREATE TABLE VARIETE_GDD.RECETA_MEDICAMENTOS (
	RECMED_RECETA INTEGER NOT NULL,
	RECMED_MEDICAMENTOS INTEGER NOT NULL,
	RECMED_CANTIDAD INTEGER DEFAULT '1'
)


CREATE TABLE VARIETE_GDD.MEDICAMENTOS (
	MED_CODIGO INTEGER IDENTITY(1,1) NOT NULL,
	MED_NOMBRE VARCHAR(255)
)


CREATE TABLE VARIETE_GDD.PLANES (
	PLA_CODIGO NUMERIC(18) NOT NULL,
	PLA_DESCRIPCION VARCHAR(255),
	PLA_PRECIO_BONO_FARMACIA NUMERIC(18) DEFAULT '0',
	PLA_PRECIO_BONO_CONSULTA NUMERIC (18) DEFAULT '0'	
)


CREATE TABLE VARIETE_GDD.COMPRA (
	COM_CODIGO INTEGER IDENTITY(1,1) NOT NULL,
	COM_FECHA DATETIME,
	COM_CANTIDAD_BONO_FARMACIA INTEGER, 
	COM_CANTIDAD_BONO_CONSULTA INTEGER,  
	COM_PRECIO FLOAT,
	COM_AFILIADO NUMERIC(8) NOT NULL	
)	


CREATE TABLE VARIETE_GDD.AGENDA(
	AGE_CODIGO INTEGER IDENTITY(1,1) NOT NULL,
	AGE_PROFESIONAL NUMERIC(8) NOT NULL,
	AGE_FECHA_INICIO DATETIME DEFAULT NULL,
	AGE_FECHA_FIN DATETIME DEFAULT NULL
)


--CREATE TABLE VARIETE_GDD.DIAS_ATENCION(
--	DIAATE_CODIGO INTEGER IDENTITY(1,1) NOT NULL,
--    DIAATE_DIA CHAR (2) NOT NULL,
--    DIAATE_HORARIO_INICIO DATETIME,
--    DIAATE_HORARIO_FIN DATETIME,
-- --   DIAATE_FECHA DATETIME,
--    DIAATE_AGENDA INTEGER NOT NULL
--)

CREATE TABLE VARIETE_GDD.PLANES_MODIFICADOS(
	PLAMOD_CODIGO INTEGER IDENTITY (1,1) NOT NULL,
	PLAMOD_PLAN_NUEVO NUMERIC(18) NOT NULL,
	PLAMOD_PLAN_VIEJO NUMERIC(18) NOT NULL,
	PLAMOD_FECHA DATETIME,
	PLAMOD_MOTIVO VARCHAR(255),
	PLAMOD_AFILIADO NUMERIC(8) NOT NULL
)


CREATE TABLE VARIETE_GDD.CANCELACION_TURNO(
	CANTUR_CODIGO INTEGER IDENTITY (1,1) NOT NULL,
	CANTUR_TURNO INTEGER NOT NULL,
	CANTUR_RAZON VARCHAR (255)
)

               
--CONSTRAINTS (PK Y FK)

--//USUARIO
ALTER TABLE VARIETE_GDD.USUARIO ADD CONSTRAINT Pk_Usuario PRIMARY KEY (USU_DNI);

--//MEDICAMENTOS	
ALTER TABLE VARIETE_GDD.MEDICAMENTOS ADD CONSTRAINT Pk_Medicamentos PRIMARY KEY (MED_CODIGO);

--//PLANES
ALTER TABLE VARIETE_GDD.PLANES ADD CONSTRAINT Pk_Planes PRIMARY KEY (PLA_CODIGO);

--//ESPECIALIDADES
ALTER TABLE VARIETE_GDD.ESPECIALIDADES ADD CONSTRAINT Pk_Especialidades PRIMARY KEY (ESP_CODIGO);

--//ROL
ALTER TABLE VARIETE_GDD.ROL ADD CONSTRAINT Pk_Rol PRIMARY KEY (ROL_NOMBRE);

--//FUNCIONALIDADES
ALTER TABLE VARIETE_GDD.FUNCIONALIDADES ADD CONSTRAINT Pk_Funcionalidades PRIMARY KEY (FUN_CODIGO);

--//AFILIADO
ALTER TABLE VARIETE_GDD.AFILIADO ADD CONSTRAINT Pk_Afiliado PRIMARY KEY (AFI_DNI);
ALTER TABLE VARIETE_GDD.AFILIADO ADD CONSTRAINT Fk_Afiliado_Afiliado FOREIGN KEY (AFI_DNI) REFERENCES VARIETE_GDD.USUARIO(USU_DNI);
ALTER TABLE VARIETE_GDD.AFILIADO ADD CONSTRAINT Fk_Afiliado_Plan FOREIGN KEY (AFI_PLAN_MEDICO) REFERENCES VARIETE_GDD.PLANES(PLA_CODIGO);

--//PROFESIONAL	
ALTER TABLE VARIETE_GDD.PROFESIONAL ADD CONSTRAINT Pk_Profesional PRIMARY KEY (PRO_DNI);
ALTER TABLE VARIETE_GDD.PROFESIONAL ADD CONSTRAINT Fk_Pro_Profesional FOREIGN KEY (PRO_DNI) REFERENCES VARIETE_GDD.USUARIO(USU_DNI);

--//PROFESIONAL_ESPECIALIDADES
ALTER TABLE VARIETE_GDD.PROFESIONAL_ESPECIALIDADES ADD CONSTRAINT Pk_Profesional_Especialidades PRIMARY KEY (PROESP_PROFESIONAL,PROESP_ESPECIALIDAD);
ALTER TABLE VARIETE_GDD.PROFESIONAL_ESPECIALIDADES ADD CONSTRAINT Fk_Pro_Esp_Profesional  FOREIGN KEY (PROESP_PROFESIONAL) REFERENCES VARIETE_GDD.PROFESIONAL(PRO_DNI);
ALTER TABLE VARIETE_GDD.PROFESIONAL_ESPECIALIDADES ADD CONSTRAINT Fk_Pro_Esp_Especialidad FOREIGN KEY (PROESP_ESPECIALIDAD) REFERENCES VARIETE_GDD.ESPECIALIDADES(ESP_CODIGO);

--//ROL_USUARIO
ALTER TABLE VARIETE_GDD.ROL_USUARIO ADD CONSTRAINT Pk_Rol_Usuario PRIMARY KEY (ROLUSU_USUARIO,ROLUSU_ROL);
ALTER TABLE VARIETE_GDD.ROL_USUARIO ADD CONSTRAINT Fk_Rol_Usuario_Usu FOREIGN KEY (ROLUSU_USUARIO) REFERENCES VARIETE_GDD.USUARIO(USU_DNI);
ALTER TABLE VARIETE_GDD.ROL_USUARIO ADD CONSTRAINT Fk_Rol_Usuario_Rol FOREIGN KEY (ROLUSU_ROL) REFERENCES VARIETE_GDD.ROL(ROL_NOMBRE);

--//ROL_FUNCIONALIDADES
ALTER TABLE VARIETE_GDD.ROL_FUNCIONALIDADES ADD CONSTRAINT Pk_Rol_Funcionalidades PRIMARY KEY (ROLFUN_ROL,ROLFUN_FUNCIONALIDAD);
ALTER TABLE VARIETE_GDD.ROL_FUNCIONALIDADES ADD CONSTRAINT Fk_Rol_Funcionalidades_Rol FOREIGN KEY (ROLFUN_ROL) REFERENCES VARIETE_GDD.ROL(ROL_NOMBRE);
ALTER TABLE VARIETE_GDD.ROL_FUNCIONALIDADES ADD CONSTRAINT Fk_Rol_Funcionalidades_Fun FOREIGN KEY (ROLFUN_FUNCIONALIDAD) REFERENCES VARIETE_GDD.FUNCIONALIDADES(FUN_CODIGO);

--//COMPRA
ALTER TABLE VARIETE_GDD.COMPRA ADD CONSTRAINT Pk_Compra PRIMARY KEY (COM_CODIGO);
ALTER TABLE VARIETE_GDD.COMPRA ADD CONSTRAINT Fk_Compra_Afiliado FOREIGN KEY (COM_AFILIADO) REFERENCES VARIETE_GDD.AFILIADO(AFI_DNI);

--//TURNOS
ALTER TABLE VARIETE_GDD.TURNOS ADD CONSTRAINT Pk_Turnos PRIMARY KEY (TUR_CODIGO);
ALTER TABLE VARIETE_GDD.TURNOS ADD CONSTRAINT Fk_Turnos_Pro FOREIGN KEY (TUR_PROFESIONAL) REFERENCES VARIETE_GDD.PROFESIONAL(PRO_DNI);
ALTER TABLE VARIETE_GDD.TURNOS ADD CONSTRAINT Fk_Turnos_Afi FOREIGN KEY (TUR_AFILIADO) REFERENCES VARIETE_GDD.AFILIADO(AFI_DNI);

--//CONSULTA
ALTER TABLE VARIETE_GDD.CONSULTA ADD CONSTRAINT Pk_Consulta PRIMARY KEY (CON_CODIGO);
ALTER TABLE VARIETE_GDD.CONSULTA ADD CONSTRAINT Fk_Consulta_Pro FOREIGN KEY (CON_PROFESIONAL) REFERENCES VARIETE_GDD.PROFESIONAL(PRO_DNI);
ALTER TABLE VARIETE_GDD.CONSULTA ADD CONSTRAINT Fk_Consulta_Afi FOREIGN KEY (CON_AFILIADO) REFERENCES VARIETE_GDD.AFILIADO(AFI_DNI);
ALTER TABLE VARIETE_GDD.CONSULTA ADD CONSTRAINT Fk_Consulta_Turno FOREIGN KEY (CON_TURNOS) REFERENCES VARIETE_GDD.TURNOS(TUR_CODIGO);

--//BONO_CONSULTA
ALTER TABLE VARIETE_GDD.BONO_CONSULTA ADD CONSTRAINT Pk_Bono_Consulta PRIMARY KEY (BONCON_CODIGO);
ALTER TABLE VARIETE_GDD.BONO_CONSULTA ADD CONSTRAINT Fk_Bono_Consulta_Afi FOREIGN KEY (BONCON_AFILIADO) REFERENCES VARIETE_GDD.AFILIADO(AFI_DNI);
ALTER TABLE VARIETE_GDD.BONO_CONSULTA ADD CONSTRAINT Fk_Bono_Consulta_Consulta FOREIGN KEY (BONCON_CONSULTA) REFERENCES VARIETE_GDD.CONSULTA(CON_CODIGO);
ALTER TABLE VARIETE_GDD.BONO_CONSULTA ADD CONSTRAINT Fk_Bono_Consulta_Plan FOREIGN KEY (BONCON_PLAN) REFERENCES VARIETE_GDD.PLANES(PLA_CODIGO);
ALTER TABLE VARIETE_GDD.BONO_CONSULTA ADD CONSTRAINT Fk_Bono_Consulta_Compra FOREIGN KEY (BONCON_COMPRA) REFERENCES VARIETE_GDD.COMPRA(COM_CODIGO);

--//BONO_FARMACIA
ALTER TABLE VARIETE_GDD.BONO_FARMACIA ADD CONSTRAINT Pk_Bono_Farmacia PRIMARY KEY (BONFAR_CODIGO);
ALTER TABLE VARIETE_GDD.BONO_FARMACIA ADD CONSTRAINT Fk_Bono_Farmacia_Afi FOREIGN KEY (BONFAR_AFILIADO) REFERENCES VARIETE_GDD.AFILIADO(AFI_DNI);
ALTER TABLE VARIETE_GDD.BONO_FARMACIA ADD CONSTRAINT Fk_Bono_Farmacia_Plan FOREIGN KEY (BONFAR_PLAN) REFERENCES VARIETE_GDD.PLANES(PLA_CODIGO);
ALTER TABLE VARIETE_GDD.BONO_FARMACIA ADD CONSTRAINT Fk_Bono_Farmacia_Compra FOREIGN KEY (BONFAR_COMPRA) REFERENCES VARIETE_GDD.COMPRA(COM_CODIGO);


--//RECETA
ALTER TABLE VARIETE_GDD.RECETA ADD CONSTRAINT Pk_Receta PRIMARY KEY (REC_CODIGO);
ALTER TABLE VARIETE_GDD.RECETA ADD CONSTRAINT Fk_Receta_Bono_Far FOREIGN KEY (REC_BONFAR) REFERENCES VARIETE_GDD.BONO_FARMACIA(BONFAR_CODIGO);

--//RECETA_MEDICAMENTOS
ALTER TABLE VARIETE_GDD.RECETA_MEDICAMENTOS ADD CONSTRAINT Pk_Rec_Med PRIMARY KEY (RECMED_RECETA,RECMED_MEDICAMENTOS);
ALTER TABLE VARIETE_GDD.RECETA_MEDICAMENTOS ADD CONSTRAINT Fk_Rec_Med_Receta FOREIGN KEY (RECMED_RECETA) REFERENCES VARIETE_GDD.RECETA(REC_CODIGO);
ALTER TABLE VARIETE_GDD.RECETA_MEDICAMENTOS ADD CONSTRAINT Fk_Rec_Med_Medicamento FOREIGN KEY (RECMED_MEDICAMENTOS) REFERENCES VARIETE_GDD.MEDICAMENTOS(MED_CODIGO);

--//AGENDA
ALTER TABLE VARIETE_GDD.AGENDA ADD CONSTRAINT Pk_Agenda PRIMARY KEY (AGE_CODIGO);
ALTER TABLE VARIETE_GDD.AGENDA ADD CONSTRAINT Fk_Agenda_Profesional FOREIGN KEY (AGE_PROFESIONAL) REFERENCES VARIETE_GDD.PROFESIONAL(PRO_DNI);

--//DIAS_ATENCION
--ALTER TABLE VARIETE_GDD.DIAS_ATENCION ADD PRIMARY KEY (DIAATE_CODIGO);
--ALTER TABLE VARIETE_GDD.DIAS_ATENCION ADD FOREIGN KEY (DIAATE_AGENDA) REFERENCES VARIETE_GDD.AGENDA(AGE_CODIGO);

--//PLANES_MODIFICADOS
ALTER TABLE VARIETE_GDD.PLANES_MODIFICADOS ADD CONSTRAINT Pk_Planes_Modif PRIMARY KEY (PLAMOD_CODIGO);
ALTER TABLE VARIETE_GDD.PLANES_MODIFICADOS ADD CONSTRAINT Fk_Planes_Modif_PlanNew FOREIGN KEY (PLAMOD_PLAN_NUEVO) REFERENCES VARIETE_GDD.PLANES(PLA_CODIGO);
ALTER TABLE VARIETE_GDD.PLANES_MODIFICADOS ADD CONSTRAINT Fk_Planes_Modif_PlanOld FOREIGN KEY (PLAMOD_PLAN_VIEJO) REFERENCES VARIETE_GDD.PLANES(PLA_CODIGO);
ALTER TABLE VARIETE_GDD.PLANES_MODIFICADOS ADD CONSTRAINT Fk_Planes_Modif_Afi FOREIGN KEY (PLAMOD_AFILIADO) REFERENCES VARIETE_GDD.AFILIADO(AFI_DNI);

--//CANCELACION_TURNO
ALTER TABLE VARIETE_GDD.CANCELACION_TURNO ADD CONSTRAINT Pk_Cancelacion_Turno PRIMARY KEY (CANTUR_CODIGO);
ALTER TABLE VARIETE_GDD.CANCELACION_TURNO ADD CONSTRAINT Fk_Cancelacion_Turno_TurCodigo FOREIGN KEY (CANTUR_TURNO) REFERENCES VARIETE_GDD.TURNOS(TUR_CODIGO);

GO

--// MIGRACION

--// USUARIO, AFILIADO
	--Aqui hay una persona con el mismo mail que otra no se respeta UNIQUE de mail
	--El mail en cuestion es abigail_López@gmail.com
	INSERT INTO [VARIETE_GDD].[USUARIO] (USU_USERNAME, USU_CLAVE, USU_DNI, USU_NOMBRES, USU_APELLIDO,USU_DIRECCION,USU_TELEFONO,USU_MAIL,USU_FECHA_NACIMIENTO) 
	SELECT DISTINCT Paciente_Mail, 
					Paciente_Dni, 
					Paciente_Dni, 
					Paciente_Nombre, 
					Paciente_Apellido,	
					Paciente_Direccion, 
					Paciente_Telefono, 
					Paciente_Mail,	
					Paciente_Fecha_Nac 
	FROM  gd_esquema.Maestra
	WHERE Paciente_Dni IS NOT NULL	

--// USUARIO, PROFESIONAL

	INSERT INTO [VARIETE_GDD].[USUARIO] (USU_USERNAME, USU_CLAVE, USU_DNI, USU_NOMBRES, USU_APELLIDO,USU_DIRECCION,USU_TELEFONO,USU_MAIL,USU_FECHA_NACIMIENTO) 
	SELECT DISTINCT Medico_Mail, 
					Medico_Dni, 
					Medico_Dni, 
					Medico_Nombre, 
					Medico_Apellido, 
					Medico_Direccion, 
					Medico_Telefono, 
					Medico_Mail,
					Medico_Fecha_Nac
	FROM  gd_esquema.Maestra
	WHERE Medico_Dni IS NOT NULL
	
--// USUARIO, ADMINISTRADOR	
	--Administrador es un usuario, TABLA USUARIO no admite valor nulo en USU_DNI
	INSERT INTO [VARIETE_GDD].[USUARIO] (USU_USERNAME,USU_CLAVE,USU_DNI,USU_NOMBRES,USU_APELLIDO,USU_DIRECCION,USU_TELEFONO,USU_MAIL,USU_FECHA_NACIMIENTO) 
	VALUES 	('admin','w23e','34784819',NULL,NULL,NULL,NULL,NULL,NULL)

--// AFILIADO

	INSERT INTO [VARIETE_GDD].[AFILIADO] (AFI_DNI, AFI_PLAN_MEDICO) 
	SELECT DISTINCT Paciente_Dni, 
					Plan_Med_Codigo 
	FROM gd_esquema.Maestra
		 JOIN VARIETE_GDD.PLANES PL ON PL.PLA_CODIGO=Plan_Med_Codigo
	WHERE Paciente_Dni IS NOT NULL
	
--// PROFESIONAL

	INSERT INTO [VARIETE_GDD].[PROFESIONAL] (PRO_DNI) 
	SELECT DISTINCT Medico_Dni
	FROM gd_esquema.Maestra
	WHERE Medico_Dni IS NOT NULL

--// ROL
	INSERT INTO [VARIETE_GDD].[ROL] (ROL_NOMBRE,ROL_HABILITADO) 
	VALUES ('ADMINISTRADOR','1'),
		   ('AFILIADO','1'),
		   ('PROFESIONAL','1')
		   
--// ROL_USUARIO, ADMINISTRADOR
	INSERT INTO [VARIETE_GDD].[ROL_USUARIO] (ROLUSU_USUARIO,ROLUSU_ROL) 
	VALUES ('34784819','ADMINISTRADOR')
	
--// ROL_USUARIO, PROFESIONAL Y AFILIADO

	INSERT INTO [VARIETE_GDD].[ROL_USUARIO] (ROLUSU_USUARIO,ROLUSU_ROL) 
	SELECT DISTINCT Medico_Dni,'PROFESIONAL' FROM gd_esquema.Maestra
	UNION 
	SELECT DISTINCT Paciente_Dni,'AFILIADO' FROM gd_esquema.Maestra
	
--// FUNCIONALIDADES

--	SET IDENTITY_INSERT VARIETE_GDD.FUNCIONALIDADES ON
	--Dice que FUNCIONALIDADES no tiene ningun IDENTITY y tiene razon xP

	INSERT INTO [VARIETE_GDD].[FUNCIONALIDADES] (FUN_CODIGO,FUN_DESCRIPCION) 
	VALUES 	('1','Abm de Rol'), 
			('2','Registro de Usuario'), 
			('3','Abm Afiliado'), 
			('4','Abm Profesional'), 
			('5','Abm Especialidades Médicas'), 
			('6','Abm de Plan'), 
			('7','Registrar AGENDA Profesional'), 
			('8','Compra de bonos'), 
			('9','Pedido de turno'), 
			('10','Registro de llegada para atención médica'), 
			('11','Registro de resultado para atención médica'), 
			('12','Cancelar atención médica'), 
			('13','Generar Receta'), 
			('14','Listado estadístico')
	
	--SET IDENTITY_INSERT VARIETE_GDD.FUNCIONALIDADES OFF

--// ROL_FUNCIONALIDADES
	--Aca marca mal porque dice que la pk ROLFUN_ROL no es unica
	INSERT INTO [VARIETE_GDD].[ROL_FUNCIONALIDADES] (ROLFUN_ROL,ROLFUN_FUNCIONALIDAD) 
	VALUES 	('ADMINISTRADOR','1'), 
			('ADMINISTRADOR','2'), 
			('ADMINISTRADOR','3'), 
			('ADMINISTRADOR','4'), 
			('ADMINISTRADOR','5'), 
			('ADMINISTRADOR','6'), 
			('ADMINISTRADOR','7'), 
			('ADMINISTRADOR','8'), 
			('ADMINISTRADOR','9'),
			('ADMINISTRADOR','10'),
			('ADMINISTRADOR','11'), 
			('ADMINISTRADOR','12'), 
			('ADMINISTRADOR','13'), 
			('ADMINISTRADOR','14'), 
			('AFILIADO','8'), 
			('AFILIADO','9'), 
			('AFILIADO','12'), 
			('AFILIADO','3'),
			('PROFESIONAL','10'), 
			('PROFESIONAL','5'), 
			('PROFESIONAL','7'),
			('PROFESIONAL','12'), 
			('PROFESIONAL','13')

--// PLANES

--	SET IDENTITY_INSERT VARIETE_GDD.PLANES ON
	-- No lo permite porque PLANES no tiene una columna con propiedad IDENTITY
	-- Sale error por querer insertar un Plan duplicado
	-- El plan duplicado es 555555 o_o
	INSERT INTO [VARIETE_GDD].[PLANES] (PLA_CODIGO,PLA_DESCRIPCION,PLA_PRECIO_BONO_FARMACIA,PLA_PRECIO_BONO_CONSULTA) 
	SELECT DISTINCT Plan_Med_Codigo, 
					Plan_Med_Descripcion, 
					Plan_Med_Precio_Bono_Farmacia, 
					Plan_Med_Precio_Bono_Consulta
	FROM gd_esquema.Maestra
	WHERE Plan_Med_Codigo IS NOT NULL
	
	--SET IDENTITY_INSERT VARIETE_GDD.PLANES OFF

--// ESPECIALIDADES

	--SET IDENTITY_INSERT VARIETE_GDD.ESPECIALIDADES ON
	  --No permite porque ESPECIALIDADES no tiene una columna con propiedad IDENTITY
	INSERT INTO [VARIETE_GDD].[ESPECIALIDADES] (ESP_CODIGO,ESP_DESCRIPCION,ESP_TIPO,ESP_TIPO_DESCRIPCION) 
	SELECT DISTINCT Especialidad_Codigo, Especialidad_Descripcion, Tipo_Especialidad_Codigo, Tipo_Especialidad_Descripcion
	FROM gd_esquema.Maestra
	WHERE Especialidad_Codigo IS NOT NULL
	
--	SET IDENTITY_INSERT VARIETE_GDD.ESPECIALIDADES OFF

	
--// PROFESIONAL_ESPECIALIDADES

	INSERT INTO [VARIETE_GDD].[PROFESIONAL_ESPECIALIDADES] (PROESP_PROFESIONAL,PROESP_ESPECIALIDAD) 
	SELECT DISTINCT PRO_DNI,ESP_CODIGO
	FROM VARIETE_GDD.PROFESIONAL JOIN gd_esquema.Maestra ON Medico_Dni=PRO_DNI 
								 JOIN VARIETE_GDD.ESPECIALIDADES ON Especialidad_Codigo=ESP_CODIGO 
	WHERE Especialidad_Codigo IS NOT NULL AND Medico_Dni IS NOT NULL

--// TURNOS

	SET IDENTITY_INSERT VARIETE_GDD.TURNOS ON
	-- Le agregue IDENTITY porque faltaba
	-- En las demás no sé cuales lleva IDENTITY
	INSERT INTO [VARIETE_GDD].[TURNOS] (TUR_CODIGO,TUR_PROFESIONAL,TUR_AFILIADO,TUR_FECHA) 
	SELECT DISTINCT M.Turno_Numero,PRO_DNI,AFI_DNI,M.Turno_Fecha
	FROM VARIETE_GDD.PROFESIONAL JOIN gd_esquema.Maestra M ON Medico_Dni=PRO_DNI
								 JOIN VARIETE_GDD.AFILIADO ON Paciente_Dni=AFI_DNI
	WHERE M.Turno_Numero IS NOT NULL AND Medico_Dni IS NOT NULL AND Paciente_Dni IS NOT NULL
	
	SET IDENTITY_INSERT VARIETE_GDD.TURNOS OFF		

--// COMPRAS

	INSERT INTO [VARIETE_GDD].[COMPRA] (COM_FECHA,COM_CANTIDAD_BONO_FARMACIA,COM_CANTIDAD_BONO_CONSULTA,COM_PRECIO,COM_AFILIADO) 
	SELECT M.Compra_Bono_Fecha,
		  (CASE WHEN Bono_Farmacia_Numero IS NOT NULL THEN 1 ELSE 0 END),
		  (CASE WHEN Bono_Consulta_Numero IS NOT NULL THEN 1 ELSE 0 END),
		  (CASE WHEN Bono_Farmacia_Numero IS NOT NULL THEN M.Plan_Med_Precio_Bono_Farmacia ELSE M.Plan_Med_Precio_Bono_Consulta END),
		  AFI_DNI
	FROM  gd_esquema.Maestra M JOIN VARIETE_GDD.AFILIADO ON M.Paciente_Dni=AFI_DNI
							   JOIN VARIETE_GDD.PLANES ON M.Plan_Med_Codigo=PLA_CODIGO 
	WHERE Compra_Bono_Fecha IS NOT NULL  

--// BONO CONSULTA

	SET IDENTITY_INSERT VARIETE_GDD.BONO_CONSULTA ON
	-- Le agregué a BONO_CONSULTA un IDENTITY para que funcione esto
	INSERT INTO [VARIETE_GDD].BONO_CONSULTA(BONCON_CODIGO ,BONCON_AFILIADO ,BONCON_CONSULTA,BONCON_FECHA ,BONCON_PLAN, BONCON_COMPRA)
	SELECT DISTINCT M.Bono_Consulta_Numero,
					AFI_DNI,
					M.Bono_Consulta_Numero,
					M.Bono_Consulta_Fecha_Impresion, 
					AFI_PLAN_MEDICO,
					COM_CODIGO
	FROM gd_esquema.Maestra M JOIN VARIETE_GDD.AFILIADO ON M.Paciente_Dni=AFI_DNI 
							  JOIN VARIETE_GDD.COMPRA ON COM_AFILIADO=AFI_DNI AND COM_FECHA=M.Bono_Consulta_Fecha_Impresion
	WHERE M.Bono_Consulta_Numero IS NOT NULL AND M.Compra_Bono_Fecha IS NOT NULL  
	 	 
	SET IDENTITY_INSERT VARIETE_GDD.BONO_CONSULTA OFF
	
--// BONO FARMACIA

	SET IDENTITY_INSERT VARIETE_GDD.BONO_FARMACIA ON
	-- Agregue propiedad IDENTITY en BONO_FARMACIA
	INSERT INTO [VARIETE_GDD].[BONO_FARMACIA](BONFAR_CODIGO,BONFAR_AFILIADO ,BONFAR_FECHA ,BONFAR_PLAN,BONFAR_COMPRA)
	SELECT DISTINCT M.Bono_Farmacia_Numero,
					AFI_DNI,
					M.Bono_Farmacia_Fecha_Impresion, 
					AFI_PLAN_MEDICO,
					COM_CODIGO
	FROM gd_esquema.Maestra M JOIN VARIETE_GDD.AFILIADO ON M.Paciente_Dni=AFI_DNI 
							  JOIN VARIETE_GDD.COMPRA ON COM_AFILIADO=AFI_DNI AND COM_FECHA=M.Bono_Farmacia_Fecha_Impresion
	WHERE M.Bono_Farmacia_Numero IS NOT NULL AND M.Compra_Bono_Fecha IS NOT NULL 
	
	SET IDENTITY_INSERT VARIETE_GDD.BONO_FARMACIA OFF

--// CONSULTA

	INSERT INTO [VARIETE_GDD].[CONSULTA](CON_PROFESIONAL,CON_AFILIADO ,CON_TURNOS ,CON_FECHA_LLEGADA,CON_SINTOMAS,CON_DIAGNOSTICO,CON_BONO_CONSULTA)
	SELECT DISTINCT PRO_DNI, 
					AFI_DNI,
					TUR_CODIGO,
					M.Turno_Fecha,
					M.Consulta_Sintomas,
					M.Consulta_Enfermedades,
					BONCON_CODIGO
	FROM gd_esquema.Maestra M JOIN VARIETE_GDD.AFILIADO ON AFI_DNI=M.Paciente_Dni
							  JOIN VARIETE_GDD.PROFESIONAL ON PRO_DNI=M.Medico_Dni
							  JOIN VARIETE_GDD.BONO_CONSULTA ON BONCON_CODIGO=M.Bono_Consulta_Numero
							  JOIN VARIETE_GDD.TURNOS ON TUR_CODIGO=M.Turno_Numero
		
	WHERE M.Turno_Numero IS NOT NULL AND M.Paciente_Dni IS NOT NULL AND M.Medico_Dni IS NOT NULL AND M.Bono_Consulta_Numero IS NOT NULL
	
--// RECETA

	INSERT INTO [VARIETE_GDD].[RECETA](REC_BONFAR) 
	SELECT DISTINCT BONFAR_CODIGO					
	FROM gd_esquema.Maestra M JOIN VARIETE_GDD.BONO_FARMACIA ON BONFAR_CODIGO=M.Bono_Farmacia_Numero
	WHERE M.Bono_Farmacia_Numero IS NOT NULL 

--// MEDICAMENTOS

	INSERT INTO [VARIETE_GDD].[MEDICAMENTOS](MED_NOMBRE) 
	SELECT DISTINCT M.Bono_Farmacia_Medicamento					
	FROM gd_esquema.Maestra M 
	WHERE M.Bono_Farmacia_Medicamento IS NOT NULL 

--// RECETA_MEDICAMENTOS

	INSERT INTO [VARIETE_GDD].[RECETA_MEDICAMENTOS](RECMED_RECETA,RECMED_MEDICAMENTOS) 
	SELECT DISTINCT REC_CODIGO,
					MED_CODIGO										
	FROM gd_esquema.Maestra M JOIN VARIETE_GDD.BONO_FARMACIA ON BONFAR_CODIGO=M.Bono_Farmacia_Numero
    						  JOIN VARIETE_GDD.RECETA ON REC_BONFAR=BONFAR_CODIGO
							  JOIN VARIETE_GDD.MEDICAMENTOS ON M.Bono_Farmacia_Medicamento=MED_NOMBRE 
	WHERE M.Bono_Farmacia_Medicamento IS NOT NULL AND BONFAR_CODIGO IS NOT NULL
	GROUP BY REC_CODIGO,MED_CODIGO,M.Bono_Farmacia_Medicamento



--// AGENDA

	INSERT INTO [VARIETE_GDD].[AGENDA](AGE_PROFESIONAL,AGE_FECHA_INICIO,AGE_FECHA_FIN) 
	SELECT DISTINCT PRO_DNI,
					AGE_FECHA_INICIO= MIN(DISTINCT M.Turno_Fecha),
					AGE_FECHA_FIN= MAX(DISTINCT M.Turno_Fecha)															
	FROM gd_esquema.Maestra M JOIN VARIETE_GDD.PROFESIONAL ON PRO_DNI=M.Medico_Dni
	WHERE M.Medico_Dni IS NOT NULL 
	GROUP BY PRO_DNI, DATEPART(DAYOFYEAR,M.Turno_fecha)


GO	

--// DIAS ATENCION
	
--	INSERT INTO [VARIETE_GDD].[DIAS_ATENCION](DIAATE_DIA,DIAATE_HORARIO_INICIO,DIAATE_HORARIO_FIN,DIAATE_FECHA,DIAATE_AGENDA) 
--	SELECT DISTINCT (SELECT ),
--					DIAATE_HORARIO_INICIO=MIN(DISTINCT DATEPART(HH,M.Turno_Fecha)),
--					DIAATE_HORARIO_FIN=MAX(DISTINCT DATEPART(HH,M.Turno_Fecha)),
--					AGE_CODIGO									
--	FROM gd_esquema.Maestra M JOIN VARIETE_GDD.PROFESIONAL ON PRO_DNI=M.Medico_Dni
--							  JOIN VARIETE_GDD.AGENDA ON AGE_PROFESIONAL=PRO_DNI
--	WHERE M.Medico_Dni IS NOT NULL 
--	GROUP BY AGE_CODIGO
	

-- // TRIGGERS

-- CREACION DE TRIGGER SOBRE TABLA RECETA
-- NO SE PUEDE MODIFICAR O ELIMINAR UNA VEZ QUE FUE CREADA

IF EXISTS (SELECT * FROM dbo.sysobjects WHERE name = 'TRIGGER_RECETA' AND xtype = 'TR')
	DROP TRIGGER  VARIETE_GDD.TRIGGER_RECETA;
GO

CREATE TRIGGER VARIETE_GDD.TRIGGER_RECETA
	ON [VARIETE_GDD].[RECETA]
	INSTEAD OF UPDATE,DELETE
	AS	
		BEGIN TRANSACTION
		ROLLBACK

GO


